name: Terragrunt Drift IaC

on:
  workflow_call:
    inputs:
      account_directory:
        description: 'Directory to check for infrastructure drift'
        required: true
        type: string
      aws_region:
        description: 'AWS region for credentials'
        required: false
        type: string
        default: 'eu-south-2'
      tf_version:
        description: 'Terraform version'
        required: false
        type: string
        default: '1.10.3'
      tg_version:
        description: 'Terragrunt version'
        required: false
        type: string
        default: '0.69.11'
<<<<<<< HEAD
=======
  
  workflow_dispatch:
    inputs:
      account_directory:
        description: 'Directory to check for drift'
        required: true
        type: string
        default: 'aws/dfbx/eu-south-2'
>>>>>>> ea6e2bef05ab1ff9b6f3e3b85e610f98ce6db28d

permissions:
  id-token: write
  contents: read
  issues: write

concurrency:
  group: drift-detection-${{ inputs.account_directory || 'scheduled' }}
  cancel-in-progress: false

jobs:
  # ===========================================
  # 1. DRIFT DETECTION
  # ===========================================
  detect-drift:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.drift-check.outputs.drift_detected }}
      to_add: ${{ steps.drift-check.outputs.to_add }}
      to_change: ${{ steps.drift-check.outputs.to_change }}
      to_destroy: ${{ steps.drift-check.outputs.to_destroy }}
      total_changes: ${{ steps.drift-check.outputs.total_changes }}

    steps:
    # ===========================================
    # 1.1 CHECKOUT
    # ===========================================   
    - name: Checkout repository
      uses: actions/checkout@v4

    # ===========================================
    # 1.2 SETUP TERRAFORM AND TERRAGRUNT
    # ===========================================      
    - name: Setup terragrunt
      uses: darthfabax-org/iac/.github/actions/setup-terragrunt@main
      with:
        terraform-version: ${{ inputs.tf_version }}
        terragrunt-version: ${{ inputs.tg_version }}

    # ===========================================
    # 1.3 CONFIGURE AWS CREDENTIALS
    # ===========================================      
    - name: Setup AWS credentials
      uses: darthfabax-org/iac/.github/actions/setup-aws@main
      with:
        role-to-assume: ${{ secrets.AWS_ACTIONS_ROLE_ARN }}
        aws-region: ${{ inputs.aws_region }}
        role-session-name: github-actions-terragrunt-drift

    # ===========================================
    # 1.4 DETECT DRIFT
    # ===========================================
    - name: Run drift detection
      id: drift-check
      working-directory: ${{ inputs.account_directory }}
      continue-on-error: true
      run: |
        echo "::group::Running Drift Detection for ${{ inputs.account_directory }}"
        
        # Run plan with detailed exit code
        set +e
        terragrunt run-all plan \
          -detailed-exitcode \
          --terragrunt-non-interactive \
          -no-color 2>&1 | tee plan_output.txt
        TG_EXIT=${PIPESTATUS[0]}
        set -e
        
        echo "::endgroup::"
        
        # Parse plan output for changes
        CHANGES=$(grep -E "Plan: [0-9]+ to add, [0-9]+ to change, [0-9]+ to destroy" plan_output.txt || true)
        
        # Extract individual counts
        TO_ADD=$(echo "$CHANGES" | grep -oP '\d+(?= to add)' | head -1 || echo "0")
        TO_CHANGE=$(echo "$CHANGES" | grep -oP '\d+(?= to change)' | head -1 || echo "0")
        TO_DESTROY=$(echo "$CHANGES" | grep -oP '\d+(?= to destroy)' | head -1 || echo "0")
        
        TOTAL=$((TO_ADD + TO_CHANGE + TO_DESTROY))
        
        echo "to_add=$TO_ADD" >> $GITHUB_OUTPUT
        echo "to_change=$TO_CHANGE" >> $GITHUB_OUTPUT
        echo "to_destroy=$TO_DESTROY" >> $GITHUB_OUTPUT
        echo "total_changes=$TOTAL" >> $GITHUB_OUTPUT
        
        if [ $TOTAL -gt 0 ]; then
          echo "drift_detected=true" >> $GITHUB_OUTPUT
          
          echo "::warning::âš ï¸ DRIFT DETECTED!"
          echo "::warning::Changes: $TO_ADD to add, $TO_CHANGE to change, $TO_DESTROY to destroy"
          
          # Save detailed drift report
          cat plan_output.txt > drift_details.txt
          
          exit 1
        else
          echo "drift_detected=false" >> $GITHUB_OUTPUT
          echo "::notice::âœ… No drift detected - infrastructure matches state"
        fi

    # ===========================================
    # 1.5 UPLOAD DRIFT DETAILS
    # ===========================================
    - name: Upload drift details artifact
      if: steps.drift-check.outputs.drift_detected == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: drift-details-${{ github.run_id }}
        path: ${{ inputs.account_directory }}/drift_details.txt
        retention-days: 7
        if-no-files-found: warn

    # ===========================================
    # 1.6 CREATE/UPDATE GITHUB ISSUE
    # ===========================================
    - name: Manage drift detection issue
      if: steps.drift-check.outputs.drift_detected == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const driftInfo = {
            directory: '${{ inputs.account_directory }}',
            toAdd: '${{ steps.drift-check.outputs.to_add }}',
            toChange: '${{ steps.drift-check.outputs.to_change }}',
            toDestroy: '${{ steps.drift-check.outputs.to_destroy }}',
            total: '${{ steps.drift-check.outputs.total_changes }}',
            timestamp: new Date().toISOString(),
            runUrl: `${context.payload.repository.html_url}/actions/runs/${context.runId}`
          };
          
          const issueBody = `## ðŸš¨ Infrastructure Drift Detected
          
          **Directory:** \`${driftInfo.directory}\`  
          **Total Changes:** ${driftInfo.total}
          
          ### Drift Summary
          | Type | Count |
          |------|-------|
          | âž• Resources to add | ${driftInfo.toAdd} |
          | ðŸ”„ Resources to change | ${driftInfo.toChange} |
          | âŒ Resources to destroy | ${driftInfo.toDestroy} |
          
          ### Required Actions
          1. ðŸ“¥ [Download drift details artifact](${driftInfo.runUrl})
          2. ðŸ” Review the changes in detail
          3. ðŸ› ï¸ Remediate the drift:
             - Update Terraform code to match actual state, OR
             - Apply Terraform to fix infrastructure
          4. âœ… Close this issue once resolved
          
          ### Additional Context
          - **Workflow Run:** [View logs](${driftInfo.runUrl})
          - **Detected At:** ${driftInfo.timestamp}
          - **Branch:** \`${context.ref}\`
          
          ---
          
          *This issue was automatically created by the drift detection workflow.*`;
          
          // Search for existing open drift issue for this directory
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'drift-detection',
            per_page: 100
          });
          
          const existingIssue = existingIssues.data.find(issue => 
            issue.title.includes(driftInfo.directory)
          );
          
          if (existingIssue) {
            // Update existing issue with new detection
            const updateComment = `### ðŸ”„ New Drift Detection Run
            
            **Detected At:** ${driftInfo.timestamp}  
            **Total Changes:** ${driftInfo.total} (${driftInfo.toAdd} add, ${driftInfo.toChange} change, ${driftInfo.toDestroy} destroy)
            
            [View workflow run](${driftInfo.runUrl})`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: updateComment
            });
            
            core.notice(`Updated existing drift issue #${existingIssue.number}`);
          } else {
            // Create new issue
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[DRIFT] ${driftInfo.directory}`,
              body: issueBody,
              labels: ['drift-detection', 'infrastructure', 'needs-attention']
            });
            
            core.notice(`Created new drift issue #${newIssue.data.number}`);
          }

    # ===========================================
    # 1.7 GENERATE SUMMARY
    # ===========================================
    - name: Generate workflow summary
      if: always()
      run: |
        echo "## ðŸ” Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Directory:** \`${{ inputs.account_directory }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Region:** \`${{ inputs.aws_region }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.drift-check.outputs.drift_detected }}" = "true" ]; then
          echo "### âš ï¸ Drift Detected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to add | ${{ steps.drift-check.outputs.to_add }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to change | ${{ steps.drift-check.outputs.to_change }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources to destroy | ${{ steps.drift-check.outputs.to_destroy }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total changes** | **${{ steps.drift-check.outputs.total_changes }}** |" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âœ… No Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Infrastructure matches the Terraform state." >> $GITHUB_STEP_SUMMARY
        fi

  # ===========================================
  # 2. SLACK NOTIFICATION
  # ===========================================
  notify-slack:
    name: Notify Drift Status
    needs: detect-drift
    if: always()
    uses: ./.github/workflows/slack-notify.yml
    secrets: inherit
    with:
      job_status: ${{ needs.detect-drift.outputs.drift_detected == 'true' && 'failure' || 'success' }}
      message: |
        ${{ needs.detect-drift.outputs.drift_detected == 'true' && 
        format('Drift Detected in `{0}`
        
        â€¢ Changes: {1} total
        â€¢ Add: {2}
        â€¢ Change: {3}  
        â€¢ Destroy: {4}',
               github.event.inputs.account_directory || 'aws/dfbx/eu-south-2',
               needs.detect-drift.outputs.total_changes,
               needs.detect-drift.outputs.to_add,
               needs.detect-drift.outputs.to_change,
               needs.detect-drift.outputs.to_destroy,
               github.repository,
               github.run_id) || 
        format('No Drift detected in `{0}`', github.event.inputs.account_directory || 'aws/dfbx/eu-south-2') }}
      workflow_name: 'Terragrunt Drift Detection'
      mention_on_failure: '@channel'
